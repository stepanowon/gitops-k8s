## helm을 이용한 image updater 설치, 설정

helm repo add argo https://argoproj.github.io/argo-helm
helm repo update argo

helm install argocd-image-updater argo/argocd-image-updater  \
--namespace argocd \
--values values-image-updater.yaml


# 스캔 시간 간격 설정
kubectl edit deployment argocd-image-updater -n argocd

# 다음 내용 편집 : 2m --> 30s
     spec:
       containers:
       - args:
         - run
         - --interval
         - 30s



## docker image registry에 접근할 수 있는 자격증명 생성

kubectl create secret docker-registry dockerhub-cred -n argocd \
--docker-server=registry-1.docker.io \
--docker-username=[도커허브사용자명]  \
--docker-password=[도커허브토큰] 


## clusters/mycluster/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- nodeapp-deploy.yaml
- nodeapp-svc.yaml


## Argocd Image Updater CRD 작성 후 적용
```
# image-updater.yaml 파일
# 대상 애플리케이션은 argocd에 생성한 애플리케이션의 이름을 지정함
apiVersion: argocd-image-updater.argoproj.io/v1alpha1
kind: ImageUpdater
metadata:
  name: myapp-image-updater
  namespace: argocd
spec:
  # ArgoCD Application이 있는 namespace
  namespace: argocd
  # Write-back 방식 설정
  writeBackConfig:
    method: "argocd"
  # 대상 Application 선택
  applicationRefs:
    - namePattern: "nodeapp-git-app"
      images:
        - alias: "nodeapp-git"
          imageName: "stephenwon/nodeapp-git"
          commonUpdateSettings:
            updateStrategy: "semver"
            forceUpdate: true
            pullSecret: "pullsecret:argocd/dockerhub-cred"
```
- 작성후 kubectl apply -f image-updater.yaml 실행


## argocd image updater 재시작
kubectl rollout restart deployment argocd-image-updater-controller -n argocd

## argocd image updater 로그 조회
kubectl logs -n argocd $(kubectl get pods -n argocd -o jsonpath="{.items[*].metadata.name}" | tr ' ' '\n' | grep argocd-image-updater-controller)

## 최근 2분간의 image updater 로그 조회
kubectl logs -n argocd $(kubectl get pods -n argocd -o jsonpath="{.items[*].metadata.name}" | tr ' ' '\n' | grep argocd-image-updater-controller) --since 2m
